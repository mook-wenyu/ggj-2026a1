# 工程化收敛与开场优化计划（纯黑背景 / 同时实例化关卡 / StartScene 重新开始）

## 0. 需求梳理（我理解的目标）
- **工程化收敛**：减少隐式 `FindObjectOfType`/按名查找/魔法字符串；把“开始/重开/重置进度”的入口集中；保持可测试。
- **开场背景纯黑**：开场文案阶段 + gift 动画阶段，屏幕背景都必须是纯黑；gift 动画仍需可见并能定格最后一帧。
- **关卡同时实例化**：首关仍需在开场期间同步实例化，不要把加载延迟到开场结束后。
- **开始场景增加重新开始按钮**：在 `StartScene` 可操作地提供“重新开始”。

## 1. 现状快照（来自代码扫描）
- 开场流程在 `Assets/Scripts/Game/GamePrologueController.cs`：
  - 文案阶段用 `ItemInfoPopupView` 的 overlay（UI Image）做遮罩与点击推进。
  - gift 阶段隐藏面板、overlay alpha 设为 0（避免 UI 盖住 gift），gift 本体是场景物体 `gift`（`SpriteRenderer` SortingLayer=`UI`，Order=50）。
- 关卡实例化在 `Assets/Scripts/Level/LevelPrefabSwitcher.cs`：`Awake()` 立即 `Instantiate` 首关（现状已经“同时实例化”）。
- `StartScene` 目前不会停留：`Assets/Scripts/Game/StartGame.cs` 在 `Start()` 无条件 `LoadScene("MainScene")`，导致菜单按钮（包括你要加的“重新开始”）没有机会点。
- `MainScene` 的入口守门：`Assets/Scripts/Game/MainGame.cs` 会在 `Utils.initGame==false` 时把 MainScene 送回 StartScene。

## 2. 关键设计决策（为什么这么做）
### 2.1 纯黑背景且 gift 仍可见
直接把 UI overlay alpha 拉到 1 会把 gift（SpriteRenderer）也盖住，因此不走“UI 遮罩变黑”的路线。

推荐用“**世界空间黑底精灵**”实现：
- 在 `MainScene` 新增一个 `SpriteRenderer` 黑底（SortingLayer=`UI`，Order=49），确保：
  - 它会盖住所有关卡/世界画面（通常在更低 SortingLayer）。
  - gift（Order=50）仍能显示在黑底之上。
  - UI（Canvas Overlay）继续显示在最上层。

### 2.2 不延迟关卡实例化
`LevelPrefabSwitcher.Awake()` 同步实例化首关已经满足“不延迟加载”；我们的方案只做“视觉遮挡”，不改实例化时机。

### 2.3 重新开始的“重置范围”
为了工程化收敛与可扩展：
- 把“会话态重置”（例如背包静态状态）与“持久化进度重置”（例如开场完成标记）拆开。
- StartScene 的“开始游戏/重新开始”都应至少执行一次“会话态重置”，避免静态状态跨局污染。

## 3. 实施步骤（按执行顺序）
### 3.1 MainScene：新增开场黑底（仅表现层）
1) 新增资源：创建一个简单的 `Sprite`（建议 1x1 像素或纯色方块）用于黑底。
2) 在 `Assets/Scenes/MainScene.unity` 新增 GameObject：例如命名 `PrologueBackdrop`。
   - 组件：`SpriteRenderer`
   - SortingLayer：`UI`
   - Order in Layer：`49`（必须小于 gift 的 50）
   - Color：黑色（alpha=1）
   - Transform：缩放足够大覆盖视口（优先用脚本/一次性配置保证不同分辨率不露边）。
   - 默认 `SetActive(false)`（避免影响正常游戏）。

### 3.2 GamePrologueController：显式控制黑底显示/隐藏
修改 `Assets/Scripts/Game/GamePrologueController.cs`：
- 新增序列化引用：`[SerializeField] private GameObject _prologueBackdrop;`
- 在开场需要展示时（即不走“已完成跳过/已持有面具”分支）启用黑底：`_prologueBackdrop.SetActive(true)`。
- 在所有提前退出路径与结束路径都禁用黑底：
  - 已有面具直接结束
  - 已完成且跳过
  - 最终确认授予面具后
  - 异常/缺引用 `yield break` 前
- 依赖收敛：在 `MainScene` Inspector 显式绑定 `_maskController/_rootCanvas/_popupPrefab/_giftAnimator/_prologueBackdrop`，让兜底 `FindObjectOfType/Resources.Load/按名查找 gift` 尽量不走。

（可选的小收敛）
- 给 `GiftAnimationPlayer.PlayAndHoldLastFrame()` 增加超时保护，避免状态名/Animator 异常导致 while 死等（只打一次错误日志，不刷屏）。

### 3.3 StartScene：让菜单可停留 + 增加“重新开始”按钮
修改 `Assets/Scripts/Game/StartGame.cs`：
- 移除 `Start()` 中无条件 `LoadScene("MainScene")`，让 StartScene 真正成为主菜单。
- 增加按钮引用与回调：`restartGame`（或复用现有 UI 增加第三个按钮）。
- 引入场景名常量（见 3.5），避免硬编码字符串。
- “开始游戏”与“重新开始”都调用统一的会话重置入口，然后加载 MainScene。

修改 `Assets/Scenes/StartScene.unity`：
- 增加一个 Button（文案“重新开始”）并绑定到 `StartGame.OnRestartGame()`。

### 3.4 新增统一重置入口（会话态 + 进度）
新增/修改以下代码（保证可测试）：
- `Assets/Scripts/Inventory/InventoryState.cs`：新增 `Clear()` 方法，清空列表与字典（必要时补一个 `Cleared` 事件/或不加事件保持简单）。
- `Assets/Scripts/Inventory/InventoryService.cs`：新增 `Reset()`，内部调用 `State.Clear()`。
- 新增 `Assets/Scripts/Game/GameResetService.cs`（纯静态类即可）：
  - `ResetSession()`：`InventoryService.Reset()` + `PuzzleProgress.ResetAll()`（以及后续可扩展的会话态重置点）。
  - `ResetProgressForNewGame(bool keepLanguage)`：清理开场完成标记（以及未来进度 key）。

### 3.5 工程化收敛：统一场景名常量
新增 `Assets/Scripts/Game/GameSceneNames.cs`：
- `public const string StartScene = "StartScene";`
- `public const string MainScene = "MainScene";`

并修改：
- `Assets/Scripts/Game/StartGame.cs`、`Assets/Scripts/Game/MainGame.cs` 用常量替代硬编码。

### 3.6 场景依赖显式化（减少运行时全场景扫描）
MainScene Inspector 侧完成以下绑定（不改代码也能显著收敛）：
- `LevelFlowController`：绑定 `_blackPanel/_levelPanel/_levelSwitcherBehaviour`（拖拽 `WorldMgr` 上的 `LevelPrefabSwitcher`）。
- `GamePrologueController`：绑定 `_maskController/_rootCanvas/_popupPrefab/_giftAnimator/_prologueBackdrop`。

## 4. 待确认（只要你回复一次即可）
“重新开始”按钮的重置范围你更倾向于哪一种？

已确认：选择 **A. 保留语言设置**。

- 清理开场完成标记与所有“进度类”数据，但保留 `CURRENT_LANGUAGE_INDEX`。
- 实现上优先走“白名单删除进度 key”，避免误删未来的设置项。

## 5. 风险与回滚
- 黑底覆盖不全（不同分辨率露边）：优先用“足够大缩放”解决；必要时加一个小脚本按相机视口自适应。
- SortingLayer/Order 冲突：若有其他 UI 层 SpriteRenderer（Order>49）会被黑底盖住；黑底仅在开场期间启用，且 Order 固定小于 gift。
- StartScene 行为改变：移除自动跳 MainScene 后，需要玩家点击按钮进入；如不符合预期可快速恢复自动跳转（回滚一行）。

## 6. 验证步骤（实现后执行）
### 6.1 手动验证
1) 运行游戏：应停留在 StartScene，不应自动跳 MainScene。
2) StartScene 点击“开始游戏”：进入 MainScene，开场文案背景纯黑。
3) 点击一次推进到 gift：背景仍纯黑，gift 动画可见并定格最后一帧。
4) 再点一次：获得面具，黑底消失，进入正常游戏画面。
5) 再次从 StartScene 进入：若开场已完成应按现有配置跳过；且不应残留黑底。
6) 点击“重新开始”：应重新播放开场；背包/谜题等会话态不应残留。

### 6.2 自动化测试（EditMode）
- 新增 `InventoryState` 清空行为的 EditMode 测试。
- 新增 `GameResetService` 的 EditMode 测试（在 `RuntimePrefs.Mode=MemoryOnly` 下验证 key 清理与语言保留策略）。
